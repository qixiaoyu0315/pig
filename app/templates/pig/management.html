{% extends "admin_layout.html" %}

{% block title %}母猪管理 - 母猪管理系统{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="/home">首页</a></li>
<li class="breadcrumb-item active">母猪管理</li>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between mb-3">
                    <h5 class="card-title">母猪概况</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#addPigModal">
                            <i class="bi bi-plus-circle"></i> 添加母猪
                        </button>
                        <button class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-upload"></i> 导入数据
                        </button>
                    </div>
                </div>
                
                <div class="row g-4">
                    <div class="col-md-3 col-sm-6">
                        <div class="border rounded p-3 text-center">
                            <h1 class="display-4 mb-0">{{ total_count }}</h1>
                            <p class="mb-0 text-muted">总猪只数</p>
                        </div>
                    </div>
                    <div class="col-md-9 col-sm-6">
                        <div class="border rounded p-3">
                            <h5 class="mb-3 text-center">猪群状态分布</h5>
                            <div class="row">
                                {% for status, count in status_counts.items() %}
                                <div class="col-md-2 col-4 text-center mb-2">
                                    <div class="p-2 rounded
                                        {% if status == '妊娠' %}bg-info text-white
                                        {% elif status == '哺乳' %}bg-success text-white
                                        {% elif status == '分娩' %}bg-primary text-white
                                        {% elif status == '休息' %}bg-warning
                                        {% elif status == '治疗' %}bg-danger text-white
                                        {% elif status == '淘汰' %}bg-secondary text-white
                                        {% else %}bg-light
                                        {% endif %}">
                                        <h5 class="mb-0">{{ count }}</h5>
                                        <small>{{ status }}</small>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 猪舍信息 -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">猪舍信息</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for house in pig_houses %}
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>{{ house.name }}</span>
                                <span class="badge bg-primary">{{ house.current_count }}/{{ house.capacity }}</span>
                            </div>
                            <div class="card-body">
                                <p class="mb-1"><strong>位置:</strong> {{ house.location }}</p>
                                <p class="mb-1"><strong>负责人:</strong> {{ house.manager }}</p>
                                <p class="mb-1"><strong>温度:</strong> {{ house.temperature|round(1) }}°C</p>
                                <p class="mb-0"><strong>湿度:</strong> {{ house.humidity|round(1) }}%</p>
                                
                                <!-- 使用率进度条 -->
                                <div class="mt-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>使用率</span>
                                        <span>{{ (house.current_count / house.capacity * 100)|round(1) if house.capacity > 0 else 0 }}%</span>
                                    </div>
                                    <div class="progress" style="height: 10px;">
                                        {% if house.current_count / house.capacity < 0.5 %}
                                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ (house.current_count / house.capacity * 100)|round(1) if house.capacity > 0 else 0 }}%" aria-valuenow="{{ (house.current_count / house.capacity * 100)|round(1) if house.capacity > 0 else 0 }}" aria-valuemin="0" aria-valuemax="100"></div>
                                        {% elif house.current_count / house.capacity < 0.8 %}
                                            <div class="progress-bar bg-info" role="progressbar" style="width: {{ (house.current_count / house.capacity * 100)|round(1) if house.capacity > 0 else 0 }}%" aria-valuenow="{{ (house.current_count / house.capacity * 100)|round(1) if house.capacity > 0 else 0 }}" aria-valuemin="0" aria-valuemax="100"></div>
                                        {% elif house.current_count / house.capacity < 1 %}
                                            <div class="progress-bar bg-warning" role="progressbar" style="width: {{ (house.current_count / house.capacity * 100)|round(1) if house.capacity > 0 else 0 }}%" aria-valuenow="{{ (house.current_count / house.capacity * 100)|round(1) if house.capacity > 0 else 0 }}" aria-valuemin="0" aria-valuemax="100"></div>
                                        {% else %}
                                            <div class="progress-bar bg-danger" role="progressbar" style="width: {{ (house.current_count / house.capacity * 100)|round(1) if house.capacity > 0 else 0 }}%" aria-valuenow="{{ (house.current_count / house.capacity * 100)|round(1) if house.capacity > 0 else 0 }}" aria-valuemin="0" aria-valuemax="100"></div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 母猪列表 -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">母猪列表</h5>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addPigModal">
                        <i class="bi bi-plus-circle me-1"></i> 添加母猪
                    </button>
                </div>
            </div>
            <div class="card-body pb-0">
                <form method="GET" action="/pig/management" class="mb-3" id="filterForm">
                    <!-- 分页参数隐藏字段，默认第一页 -->
                    <input type="hidden" name="page" value="1" id="page_field">
                    
                    <div class="row align-items-end g-3">
                        <div class="col-md-3">
                            <label for="keyword" class="form-label">搜索耳标号</label>
                            <div class="input-group">
                                <input type="text" id="keyword" class="form-control" name="keyword" placeholder="输入耳标号" value="{{ keyword or '' }}">
                                <button class="btn btn-outline-primary" type="submit">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label for="status" class="form-label">状态筛选</label>
                            <select id="status" class="form-select" name="status">
                                <option value="">全部状态</option>
                                <option value="正常" {% if filter_status == '正常' %}selected{% endif %}>正常</option>
                                <option value="妊娠" {% if filter_status == '妊娠' %}selected{% endif %}>妊娠</option>
                                <option value="哺乳" {% if filter_status == '哺乳' %}selected{% endif %}>哺乳</option>
                                <option value="分娩" {% if filter_status == '分娩' %}selected{% endif %}>分娩</option>
                                <option value="休息" {% if filter_status == '休息' %}selected{% endif %}>休息</option>
                                <option value="治疗" {% if filter_status == '治疗' %}selected{% endif %}>治疗</option>
                                <option value="淘汰" {% if filter_status == '淘汰' %}selected{% endif %}>淘汰</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="health_status" class="form-label">健康状况</label>
                            <select id="health_status" class="form-select" name="health_status">
                                <option value="">全部健康状态</option>
                                <option value="健康" {% if filter_health_status == '健康' %}selected{% endif %}>健康</option>
                                <option value="待观察" {% if filter_health_status == '待观察' %}selected{% endif %}>待观察</option>
                                <option value="治疗中" {% if filter_health_status == '治疗中' %}selected{% endif %}>治疗中</option>
                                <option value="隔离中" {% if filter_health_status == '隔离中' %}selected{% endif %}>隔离中</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="pen_id" class="form-label">猪圈筛选</label>
                            <select id="pen_id" class="form-select" name="pen_id">
                                <option value="">全部猪圈</option>
                                {% for pen in pig_pens %}
                                <option value="{{ pen.id }}" {% if filter_pen_id|string == pen.id|string %}selected{% endif %}>{{ pen.pen_number }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex">
                                <button type="submit" class="btn btn-primary w-50 me-2">
                                    <i class="bi bi-filter me-1"></i> 应用筛选
                                </button>
                                {% if keyword or filter_status or filter_health_status or filter_pen_id %}
                                <a href="/pig/management" class="btn btn-outline-secondary w-50">
                                    <i class="bi bi-x-circle me-1"></i> 清除筛选
                                </a>
                                {% else %}
                                <button type="reset" class="btn btn-outline-secondary w-50">
                                    <i class="bi bi-arrow-counterclockwise me-1"></i> 重置
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </form>
                <div class="table-responsive">
                    <table class="table table-hover table-bordered mb-0">
                        <thead class="table-light">
                            <tr>
                                <th width="10%">耳标号</th>
                                <th width="10%">生日</th>
                                <th width="10%">品种</th>
                                <th width="10%">猪圈</th>
                                <th width="10%">状态</th>
                                <th width="10%">健康状况</th>
                                <th width="8%">体重(kg)</th>
                                <th width="12%">入场日期</th>
                                <th width="20%">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if pigs %}
                                {% for pig in pigs %}
                                <tr>
                                    <td>{{ pig.ear_tag }}</td>
                                    <td>{{ pig.birth_date.strftime('%Y-%m-%d') }}</td>
                                    <td>{{ pig.breed }}</td>
                                    <td>
                                        {% if pig.pen %}
                                        {{ pig.pen.pen_number }}
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge
                                            {% if pig.status == '妊娠' %}bg-info
                                            {% elif pig.status == '哺乳' %}bg-success
                                            {% elif pig.status == '分娩' %}bg-primary
                                            {% elif pig.status == '休息' %}bg-warning
                                            {% elif pig.status == '治疗' %}bg-danger
                                            {% elif pig.status == '淘汰' %}bg-secondary
                                            {% else %}bg-light text-dark
                                            {% endif %}">
                                            {{ pig.status }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge
                                            {% if pig.health_status == '健康' %}bg-success
                                            {% elif pig.health_status == '待观察' %}bg-warning
                                            {% elif pig.health_status == '治疗中' %}bg-danger
                                            {% elif pig.health_status == '隔离中' %}bg-dark
                                            {% else %}bg-light text-dark
                                            {% endif %}">
                                            {{ pig.health_status }}
                                        </span>
                                    </td>
                                    <td>{{ pig.weight|round(1) }}</td>
                                    <td>{{ pig.entry_date.strftime('%Y-%m-%d') }}</td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-outline-primary" title="查看详情" onclick="viewPigDetails('{{ pig.id }}')">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" title="编辑信息" onclick="editPig('{{ pig.id }}')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" title="删除" onclick="deletePig('{{ pig.id }}')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="9" class="text-center py-3">暂无数据{% if keyword or filter_status or filter_health_status or filter_pen_id %}，请尝试清除筛选条件{% endif %}</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <p class="text-muted mb-0">共 {{ total_count }} 条记录，当前显示第 {{ current_page }}/{{ total_pages }} 页</p>
                    </div>
                    <div class="col-md-6">
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-end mb-0">
                                <!-- 上一页 -->
                                <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                                    <a class="page-link" href="{{ request.url.remove_query_params(['page']) }}{% if request.query_params %}&{% else %}?{% endif %}page={{ current_page - 1 }}" {% if current_page == 1 %}tabindex="-1" aria-disabled="true"{% endif %}>上一页</a>
                                </li>
                                
                                <!-- 页码 -->
                                {% set start_page = [current_page - 2, 1] | max %}
                                {% set end_page = [start_page + 4, total_pages] | min %}
                                {% set start_page = [end_page - 4, 1] | max %}
                                
                                {% if start_page > 1 %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ request.url.remove_query_params(['page']) }}{% if request.query_params %}&{% else %}?{% endif %}page=1">1</a>
                                </li>
                                {% if start_page > 2 %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                                {% endif %}
                                {% endif %}
                                
                                {% for page_num in range(start_page, end_page + 1) %}
                                <li class="page-item {% if page_num == current_page %}active{% endif %}">
                                    <a class="page-link" href="{{ request.url.remove_query_params(['page']) }}{% if request.query_params %}&{% else %}?{% endif %}page={{ page_num }}">{{ page_num }}</a>
                                </li>
                                {% endfor %}
                                
                                {% if end_page < total_pages %}
                                {% if end_page < total_pages - 1 %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                                {% endif %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ request.url.remove_query_params(['page']) }}{% if request.query_params %}&{% else %}?{% endif %}page={{ total_pages }}">{{ total_pages }}</a>
                                </li>
                                {% endif %}
                                
                                <!-- 下一页 -->
                                <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                                    <a class="page-link" href="{{ request.url.remove_query_params(['page']) }}{% if request.query_params %}&{% else %}?{% endif %}page={{ current_page + 1 }}" {% if current_page == total_pages %}tabindex="-1" aria-disabled="true"{% endif %}>下一页</a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加母猪模态框 -->
<div class="modal fade" id="addPigModal" tabindex="-1" aria-labelledby="addPigModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addPigModalLabel">添加母猪</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addPigForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="ear_tag" class="form-label">耳标号*</label>
                            <input type="text" class="form-control" id="ear_tag" name="ear_tag" required>
                        </div>
                        <div class="col-md-6">
                            <label for="birth_date" class="form-label">出生日期*</label>
                            <input type="date" class="form-control" id="birth_date" name="birth_date" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="breed" class="form-label">品种*</label>
                            <select class="form-select" id="breed" name="breed" required>
                                <option value="">请选择品种</option>
                                <option value="大白">大白</option>
                                <option value="长白">长白</option>
                                <option value="杜洛克">杜洛克</option>
                                <option value="皮特兰">皮特兰</option>
                                <option value="巴克夏">巴克夏</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="pen_id" class="form-label">猪圈*</label>
                            <select class="form-select" id="pen_id" name="pen_id" required>
                                <option value="">请选择猪圈</option>
                                {% for pen in pig_pens %}
                                <option value="{{ pen.id }}">{{ pen.pen_number }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="status" class="form-label">状态*</label>
                            <select class="form-select" id="status" name="status" required>
                                <option value="">请选择状态</option>
                                <option value="正常">正常</option>
                                <option value="妊娠">妊娠</option>
                                <option value="哺乳">哺乳</option>
                                <option value="分娩">分娩</option>
                                <option value="休息">休息</option>
                                <option value="治疗">治疗</option>
                                <option value="淘汰">淘汰</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="health_status" class="form-label">健康状况*</label>
                            <select class="form-select" id="health_status" name="health_status" required>
                                <option value="">请选择健康状况</option>
                                <option value="健康">健康</option>
                                <option value="待观察">待观察</option>
                                <option value="治疗中">治疗中</option>
                                <option value="隔离中">隔离中</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="weight" class="form-label">体重(kg)*</label>
                            <input type="number" step="0.1" min="0" class="form-control" id="weight" name="weight" required>
                        </div>
                        <div class="col-md-6">
                            <label for="entry_date" class="form-label">入场日期*</label>
                            <input type="date" class="form-control" id="entry_date" name="entry_date" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">备注</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveAddPigBtn">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑母猪模态框 -->
<div class="modal fade" id="editPigModal" tabindex="-1" aria-labelledby="editPigModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPigModalLabel">编辑母猪</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editPigForm">
                    <input type="hidden" id="edit_pig_id" name="pig_id">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit_ear_tag" class="form-label">耳标号*</label>
                            <input type="text" class="form-control" id="edit_ear_tag" name="ear_tag" required>
                        </div>
                        <div class="col-md-6">
                            <label for="edit_birth_date" class="form-label">出生日期*</label>
                            <input type="date" class="form-control" id="edit_birth_date" name="birth_date" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit_breed" class="form-label">品种*</label>
                            <select class="form-select" id="edit_breed" name="breed" required>
                                <option value="">请选择品种</option>
                                <option value="大白">大白</option>
                                <option value="长白">长白</option>
                                <option value="杜洛克">杜洛克</option>
                                <option value="皮特兰">皮特兰</option>
                                <option value="巴克夏">巴克夏</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="edit_pen_id" class="form-label">猪圈*</label>
                            <select class="form-select" id="edit_pen_id" name="pen_id" required>
                                <option value="">请选择猪圈</option>
                                {% for pen in pig_pens %}
                                <option value="{{ pen.id }}">{{ pen.pen_number }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit_status" class="form-label">状态*</label>
                            <select class="form-select" id="edit_status" name="status" required>
                                <option value="">请选择状态</option>
                                <option value="正常">正常</option>
                                <option value="妊娠">妊娠</option>
                                <option value="哺乳">哺乳</option>
                                <option value="分娩">分娩</option>
                                <option value="休息">休息</option>
                                <option value="治疗">治疗</option>
                                <option value="淘汰">淘汰</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="edit_health_status" class="form-label">健康状况*</label>
                            <select class="form-select" id="edit_health_status" name="health_status" required>
                                <option value="">请选择健康状况</option>
                                <option value="健康">健康</option>
                                <option value="待观察">待观察</option>
                                <option value="治疗中">治疗中</option>
                                <option value="隔离中">隔离中</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit_weight" class="form-label">体重(kg)*</label>
                            <input type="number" step="0.1" min="0" class="form-control" id="edit_weight" name="weight" required>
                        </div>
                        <div class="col-md-6">
                            <label for="edit_entry_date" class="form-label">入场日期*</label>
                            <input type="date" class="form-control" id="edit_entry_date" name="entry_date" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_notes" class="form-label">备注</label>
                        <textarea class="form-control" id="edit_notes" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveEditPigBtn">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 查看母猪详情模态框 -->
<div class="modal fade" id="viewPigModal" tabindex="-1" aria-labelledby="viewPigModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewPigModalLabel">母猪详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <h5>基本信息</h5>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <tr>
                                        <th class="bg-light" width="35%">耳标号</th>
                                        <td id="view_ear_tag"></td>
                                    </tr>
                                    <tr>
                                        <th class="bg-light">出生日期</th>
                                        <td id="view_birth_date"></td>
                                    </tr>
                                    <tr>
                                        <th class="bg-light">品种</th>
                                        <td id="view_breed"></td>
                                    </tr>
                                    <tr>
                                        <th class="bg-light">体重(kg)</th>
                                        <td id="view_weight"></td>
                                    </tr>
                                    <tr>
                                        <th class="bg-light">入场日期</th>
                                        <td id="view_entry_date"></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <h5>状态信息</h5>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <tr>
                                        <th class="bg-light" width="35%">当前状态</th>
                                        <td id="view_status"></td>
                                    </tr>
                                    <tr>
                                        <th class="bg-light">健康状况</th>
                                        <td id="view_health_status"></td>
                                    </tr>
                                    <tr>
                                        <th class="bg-light">所在猪圈</th>
                                        <td id="view_pen"></td>
                                    </tr>
                                    <tr>
                                        <th class="bg-light">备注</th>
                                        <td id="view_notes"></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 饲喂记录 -->
                <div class="mt-3">
                    <h5>最近饲喂记录</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead class="bg-light">
                                <tr>
                                    <th>时间</th>
                                    <th>饲料类型</th>
                                    <th>饲料量(kg)</th>
                                    <th>持续(分钟)</th>
                                    <th>状态</th>
                                </tr>
                            </thead>
                            <tbody id="view_feeding_records">
                                <!-- 动态填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 健康记录 -->
                <div class="mt-3">
                    <h5>最近健康记录</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead class="bg-light">
                                <tr>
                                    <th>日期</th>
                                    <th>体温(°C)</th>
                                    <th>诊断</th>
                                    <th>治疗</th>
                                </tr>
                            </thead>
                            <tbody id="view_health_records">
                                <!-- 动态填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 繁育记录 -->
                <div class="mt-3">
                    <h5>繁育记录</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead class="bg-light">
                                <tr>
                                    <th>配种日期</th>
                                    <th>预产日期</th>
                                    <th>实际分娩</th>
                                    <th>总产仔</th>
                                    <th>健康产仔</th>
                                </tr>
                            </thead>
                            <tbody id="view_breeding_records">
                                <!-- 动态填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary edit-from-view">编辑信息</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 全局变量，用于存储当前正在编辑的猪ID
    let currentPigId = null;
    
    // 添加分页逻辑，处理页面跳转
    document.addEventListener('DOMContentLoaded', function() {
        // 获取所有分页链接
        const pageLinks = document.querySelectorAll('.pagination .page-link:not(.disabled)');
        
        // 为每个分页链接添加点击事件
        pageLinks.forEach(link => {
            if (!link.hasAttribute('aria-disabled')) {
                link.addEventListener('click', function(e) {
                    // 阻止默认点击行为
                    e.preventDefault();
                    
                    // 获取链接的href属性值
                    const href = this.getAttribute('href');
                    if (href) {
                        // 跳转到指定链接
                        window.location.href = href;
                    }
                });
            }
        });
        
        // 提交筛选表单时重置页码为1
        const filterForm = document.getElementById('filterForm');
        if (filterForm) {
            filterForm.addEventListener('submit', function() {
                document.getElementById('page_field').value = 1;
            });
        }
    });
    
    // 查看母猪详情
    function viewPigDetails(pigId) {
        // 发送请求获取猪详情
        fetch(`/pig/detail/${pigId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('获取数据失败');
                }
                return response.json();
            })
            .then(data => {
                // 填充基本信息
                document.getElementById('view_ear_tag').textContent = data.ear_tag;
                document.getElementById('view_birth_date').textContent = data.birth_date;
                document.getElementById('view_breed').textContent = data.breed;
                document.getElementById('view_weight').textContent = data.weight;
                document.getElementById('view_entry_date').textContent = data.entry_date;
                document.getElementById('view_status').textContent = data.status;
                document.getElementById('view_health_status').textContent = data.health_status;
                document.getElementById('view_pen').textContent = data.pen || '未分配';
                document.getElementById('view_notes').textContent = data.notes || '';
                
                // 填充饲喂记录
                const feedingRecordsElement = document.getElementById('view_feeding_records');
                feedingRecordsElement.innerHTML = '';
                
                if (data.feeding_records && data.feeding_records.length > 0) {
                    data.feeding_records.forEach(record => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${record.feed_time}</td>
                            <td>${record.feed_type || '-'}</td>
                            <td>${record.feed_amount}</td>
                            <td>${record.duration || '-'}</td>
                            <td>${record.feed_status}</td>
                        `;
                        feedingRecordsElement.appendChild(tr);
                    });
                } else {
                    feedingRecordsElement.innerHTML = '<tr><td colspan="5" class="text-center">暂无饲喂记录</td></tr>';
                }
                
                // 填充健康记录
                const healthRecordsElement = document.getElementById('view_health_records');
                healthRecordsElement.innerHTML = '';
                
                if (data.health_records && data.health_records.length > 0) {
                    data.health_records.forEach(record => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${record.record_date}</td>
                            <td>${record.temperature || '-'}</td>
                            <td>${record.diagnosis || '-'}</td>
                            <td>${record.treatment || '-'}</td>
                        `;
                        healthRecordsElement.appendChild(tr);
                    });
                } else {
                    healthRecordsElement.innerHTML = '<tr><td colspan="4" class="text-center">暂无健康记录</td></tr>';
                }
                
                // 填充繁育记录
                const breedingRecordsElement = document.getElementById('view_breeding_records');
                breedingRecordsElement.innerHTML = '';
                
                if (data.breeding_records && data.breeding_records.length > 0) {
                    data.breeding_records.forEach(record => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${record.breeding_date || '-'}</td>
                            <td>${record.expected_farrowing_date || '-'}</td>
                            <td>${record.actual_farrowing_date || '-'}</td>
                            <td>${record.total_born || '0'}</td>
                            <td>${record.born_alive || '0'}</td>
                        `;
                        breedingRecordsElement.appendChild(tr);
                    });
                } else {
                    breedingRecordsElement.innerHTML = '<tr><td colspan="5" class="text-center">暂无繁育记录</td></tr>';
                }
                
                // 存储当前猪ID
                currentPigId = pigId;
                
                // 显示详情模态框
                const viewModal = new bootstrap.Modal(document.getElementById('viewPigModal'));
                viewModal.show();
            })
            .catch(error => {
                console.error('获取猪只详情失败:', error);
                alert('获取猪只详情失败，请重试');
            });
    }
    
    // 从详情页点击编辑
    document.querySelector('.edit-from-view').addEventListener('click', function() {
        // 关闭详情模态框
        bootstrap.Modal.getInstance(document.getElementById('viewPigModal')).hide();
        // 打开编辑模态框并填充数据
        editPig(currentPigId);
    });
    
    // 编辑母猪信息
    function editPig(pigId) {
        // 发送请求获取猪详情用于编辑
        fetch(`/pig/detail/${pigId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('获取数据失败');
                }
                return response.json();
            })
            .then(data => {
                // 填充表单字段
                document.getElementById('edit_pig_id').value = pigId;
                document.getElementById('edit_ear_tag').value = data.ear_tag;
                document.getElementById('edit_birth_date').value = data.birth_date;
                document.getElementById('edit_breed').value = data.breed;
                document.getElementById('edit_weight').value = data.weight;
                document.getElementById('edit_status').value = data.status;
                document.getElementById('edit_health_status').value = data.health_status;
                document.getElementById('edit_pen_id').value = data.pen_id;
                document.getElementById('edit_entry_date').value = data.entry_date;
                document.getElementById('edit_notes').value = data.notes || '';
                
                // 显示编辑模态框
                const editModal = new bootstrap.Modal(document.getElementById('editPigModal'));
                editModal.show();
            })
            .catch(error => {
                console.error('获取猪只数据失败:', error);
                alert('获取猪只数据失败，请重试');
            });
    }
    
    // 保存编辑后的母猪信息
    document.getElementById('saveEditPigBtn').addEventListener('click', function() {
        const form = document.getElementById('editPigForm');
        const pigId = document.getElementById('edit_pig_id').value;
        
        // 检查表单是否有效
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        // 获取表单数据
        const formData = new FormData(form);
        
        // 发送请求更新猪信息
        fetch(`/pig/update/${pigId}`, {
            method: 'PUT',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('更新成功！');
                // 关闭模态框
                bootstrap.Modal.getInstance(document.getElementById('editPigModal')).hide();
                // 刷新页面以显示最新数据
                window.location.reload();
            } else {
                alert(`更新失败: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('更新猪只信息失败:', error);
            alert('更新猪只信息失败，请重试');
        });
    });
    
    // 删除猪
    function deletePig(pigId) {
        if (confirm('确定要删除这头猪吗？此操作将同时删除所有相关记录，且不可撤销。')) {
            // 发送删除请求
            fetch(`/pig/delete/${pigId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('删除成功！');
                    // 刷新页面以更新列表
                    window.location.reload();
                } else {
                    alert(`删除失败: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('删除猪只失败:', error);
                alert('删除猪只失败，请重试');
            });
        }
    }
    
    // 保存新增猪
    document.getElementById('saveAddPigBtn').addEventListener('click', function() {
        const form = document.getElementById('addPigForm');
        
        // 检查表单是否有效
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        // 获取表单数据
        const formData = new FormData(form);
        
        // 发送请求添加猪
        fetch('/pig/add', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('添加成功！');
                // 关闭模态框
                bootstrap.Modal.getInstance(document.getElementById('addPigModal')).hide();
                // 清空表单
                form.reset();
                // 刷新页面以显示新数据
                window.location.reload();
            } else {
                alert(`添加失败: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('添加猪只失败:', error);
            alert('添加猪只失败，请重试');
        });
    });
    
    // 添加猪模态框显示时设置今天日期
    document.getElementById('addPigModal').addEventListener('show.bs.modal', function () {
        // 设置默认入场日期为今天
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('entry_date').value = today;
    });
</script>
{% endblock %} 