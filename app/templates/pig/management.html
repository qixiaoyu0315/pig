{% extends "admin_layout.html" %}

{% block title %}母猪管理 - 母猪管理系统{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="/home">首页</a></li>
<li class="breadcrumb-item active">母猪管理</li>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between mb-3">
                    <h5 class="card-title">母猪概况</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#addPigModal">
                            <i class="bi bi-plus-circle"></i> 添加母猪
                        </button>
                        <button class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-upload"></i> 导入数据
                        </button>
                    </div>
                </div>
                
                <div class="row g-4">
                    <div class="col-md-3 col-sm-6">
                        <div class="border rounded p-3 text-center">
                            <h1 class="display-4 mb-0">{{ total_count }}</h1>
                            <p class="mb-0 text-muted">总猪只数</p>
                        </div>
                    </div>
                    <div class="col-md-9 col-sm-6">
                        <div class="border rounded p-3">
                            <h5 class="mb-3 text-center">猪群状态分布</h5>
                            <div class="row">
                                {% for status, count in status_counts.items() %}
                                <div class="col-md-2 col-4 text-center mb-2">
                                    <div class="p-2 rounded
                                        {% if status == '妊娠' %}bg-info text-white
                                        {% elif status == '哺乳' %}bg-success text-white
                                        {% elif status == '分娩' %}bg-primary text-white
                                        {% elif status == '休息' %}bg-warning
                                        {% elif status == '治疗' %}bg-danger text-white
                                        {% elif status == '淘汰' %}bg-secondary text-white
                                        {% else %}bg-light
                                        {% endif %}">
                                        <h5 class="mb-0">{{ count }}</h5>
                                        <small>{{ status }}</small>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 猪舍信息 -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">猪舍信息</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for house in pig_houses %}
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>{{ house.name }}</span>
                                <span class="badge bg-primary">{{ house.current_count }}/{{ house.capacity }}</span>
                            </div>
                            <div class="card-body">
                                <p class="mb-1"><strong>位置:</strong> {{ house.location }}</p>
                                <p class="mb-1"><strong>负责人:</strong> {{ house.manager }}</p>
                                <p class="mb-1"><strong>温度:</strong> {{ house.temperature|round(1) }}°C</p>
                                <p class="mb-0"><strong>湿度:</strong> {{ house.humidity|round(1) }}%</p>
                                
                                <!-- 使用率进度条 -->
                                <div class="mt-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>使用率</span>
                                        <span>{{ (house.current_count / house.capacity * 100)|round(1) if house.capacity > 0 else 0 }}%</span>
                                    </div>
                                    <div class="progress" style="height: 10px;">
                                        {% if house.current_count / house.capacity < 0.5 %}
                                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ (house.current_count / house.capacity * 100)|round(1) if house.capacity > 0 else 0 }}%" aria-valuenow="{{ (house.current_count / house.capacity * 100)|round(1) if house.capacity > 0 else 0 }}" aria-valuemin="0" aria-valuemax="100"></div>
                                        {% elif house.current_count / house.capacity < 0.8 %}
                                            <div class="progress-bar bg-info" role="progressbar" style="width: {{ (house.current_count / house.capacity * 100)|round(1) if house.capacity > 0 else 0 }}%" aria-valuenow="{{ (house.current_count / house.capacity * 100)|round(1) if house.capacity > 0 else 0 }}" aria-valuemin="0" aria-valuemax="100"></div>
                                        {% elif house.current_count / house.capacity < 1 %}
                                            <div class="progress-bar bg-warning" role="progressbar" style="width: {{ (house.current_count / house.capacity * 100)|round(1) if house.capacity > 0 else 0 }}%" aria-valuenow="{{ (house.current_count / house.capacity * 100)|round(1) if house.capacity > 0 else 0 }}" aria-valuemin="0" aria-valuemax="100"></div>
                                        {% else %}
                                            <div class="progress-bar bg-danger" role="progressbar" style="width: {{ (house.current_count / house.capacity * 100)|round(1) if house.capacity > 0 else 0 }}%" aria-valuenow="{{ (house.current_count / house.capacity * 100)|round(1) if house.capacity > 0 else 0 }}" aria-valuemin="0" aria-valuemax="100"></div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 母猪列表 -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">母猪列表</h5>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addPigModal">
                        <i class="bi bi-plus-circle me-1"></i> 添加母猪
                    </button>
                </div>
            </div>
            <div class="card-body pb-0">
                <form method="GET" action="/pig/management" class="mb-3" id="filterForm">
                    <!-- 分页参数隐藏字段，默认第一页 -->
                    <input type="hidden" name="page" value="1" id="page_field">
                    
                    <div class="row g-3">
                        <div class="col-md-3 col-12">
                            <label for="keyword" class="form-label">搜索耳标号</label>
                            <div class="input-group">
                                <input type="text" id="keyword" class="form-control" name="keyword" placeholder="输入耳标号" value="{{ keyword or '' }}">
                                <button class="btn btn-outline-primary d-md-block d-none" type="submit">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <label for="status" class="form-label">状态</label>
                            <select id="status" class="form-select" name="status">
                                <option value="">全部状态</option>
                                <option value="正常" {% if filter_status == "正常" %}selected{% endif %}>正常</option>
                                <option value="妊娠" {% if filter_status == "妊娠" %}selected{% endif %}>妊娠</option>
                                <option value="哺乳" {% if filter_status == "哺乳" %}selected{% endif %}>哺乳</option>
                                <option value="分娩" {% if filter_status == "分娩" %}selected{% endif %}>分娩</option>
                                <option value="休息" {% if filter_status == "休息" %}selected{% endif %}>休息</option>
                                <option value="治疗" {% if filter_status == "治疗" %}selected{% endif %}>治疗</option>
                                <option value="淘汰" {% if filter_status == "淘汰" %}selected{% endif %}>淘汰</option>
                            </select>
                        </div>
                        <div class="col-md-3 col-6">
                            <label for="health_status" class="form-label">健康状况</label>
                            <select id="health_status" class="form-select" name="health_status">
                                <option value="">全部健康状况</option>
                                <option value="健康" {% if filter_health_status == "健康" %}selected{% endif %}>健康</option>
                                <option value="待观察" {% if filter_health_status == "待观察" %}selected{% endif %}>待观察</option>
                                <option value="治疗中" {% if filter_health_status == "治疗中" %}selected{% endif %}>治疗中</option>
                                <option value="隔离中" {% if filter_health_status == "隔离中" %}selected{% endif %}>隔离中</option>
                            </select>
                        </div>
                        <div class="col-md-3 col-6">
                            <label for="pen_id" class="form-label">猪圈</label>
                            <select id="pen_id" class="form-select" name="pen_id">
                                <option value="">全部猪圈</option>
                                {% for pen in pig_pens %}
                                <option value="{{ pen.id }}" {% if filter_pen_id == pen.id %}selected{% endif %}>{{ pen.pen_number }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 mt-3 d-flex justify-content-between">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search"></i> 应用筛选
                            </button>
                            {% if keyword or filter_status or filter_health_status or filter_pen_id %}
                            <a href="/pig/management" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> 清除筛选
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </form>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle">
                        <thead class="bg-light">
                            <tr>
                                <th style="width: 80px;">耳标号</th>
                                <th style="width: 120px;">状态</th>
                                <th style="width: 120px;">健康状况</th>
                                <th style="width: 100px;" class="d-none d-md-table-cell">品种</th>
                                <th style="width: 100px;" class="d-none d-md-table-cell">猪圈号</th>
                                <th style="width: 100px;" class="d-none d-md-table-cell">体重</th>
                                <th style="width: 120px;" class="d-none d-md-table-cell">入栏日期</th>
                                <th style="width: 150px;">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if pigs %}
                                {% for pig in pigs %}
                                <tr>
                                    <td>{{ pig.ear_tag }}</td>
                                    <td>
                                        <span class="badge rounded-pill {{ pig.status | status_class }}">{{ pig.status }}</span>
                                    </td>
                                    <td>
                                        <span class="badge rounded-pill {{ pig.health_status | health_status_class }}">{{ pig.health_status }}</span>
                                    </td>
                                    <td class="d-none d-md-table-cell">{{ pig.breed }}</td>
                                    <td class="d-none d-md-table-cell">
                                        {% if pig.pig_pen %}
                                            <a href="/pig_pen/view/{{ pig.pig_pen.id }}" class="text-decoration-none">{{ pig.pig_pen.pen_number }}</a>
                                        {% else %}
                                            <span class="text-muted">未分配</span>
                                        {% endif %}
                                    </td>
                                    <td class="d-none d-md-table-cell">{{ pig.weight }}kg</td>
                                    <td class="d-none d-md-table-cell">{{ pig.entry_date.strftime('%Y-%m-%d') }}</td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" onclick="viewPigDetails({{ pig.id }})">
                                                <i class="bi bi-eye"></i>
                                                <span class="d-none d-sm-inline">查看</span>
                                            </button>
                                            <button class="btn btn-outline-secondary" onclick="editPig({{ pig.id }})">
                                                <i class="bi bi-pencil"></i>
                                                <span class="d-none d-sm-inline">编辑</span>
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="deletePig({{ pig.id }})">
                                                <i class="bi bi-trash"></i>
                                                <span class="d-none d-sm-inline">删除</span>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <div class="text-muted">
                                            <i class="bi bi-search fs-3 d-block mb-2"></i>
                                            暂无母猪数据或没有符合条件的记录
                                        </div>
                                        <a href="#" class="btn btn-sm btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#addPigModal">
                                            <i class="bi bi-plus-circle me-1"></i>添加母猪
                                        </a>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                
                <!-- 移动设备上显示的详细信息按钮 -->
                <div class="d-md-none mb-3 alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    点击"查看"按钮可以查看母猪的完整信息
                </div>
                
                <!-- 分页区 -->
                {% if total_pages > 1 %}
                <nav aria-label="Page navigation" class="mt-4">
                    <ul class="pagination justify-content-center flex-wrap">
                        {% if current_page > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="javascript:void(0);" onclick="goToPage({{ current_page - 1 }})" aria-label="上一页">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <a class="page-link" href="#" aria-label="上一页">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        {% endif %}
                        
                        {% for i in range(1, total_pages + 1) %}
                            {% if i == current_page %}
                            <li class="page-item active"><a class="page-link" href="#">{{ i }}</a></li>
                            {% elif i >= current_page - 2 and i <= current_page + 2 %}
                            <li class="page-item"><a class="page-link" href="javascript:void(0);" onclick="goToPage({{ i }})">{{ i }}</a></li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if current_page < total_pages %}
                        <li class="page-item">
                            <a class="page-link" href="javascript:void(0);" onclick="goToPage({{ current_page + 1 }})" aria-label="下一页">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <a class="page-link" href="#" aria-label="下一页">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}

                <!-- 添加"添加母猪"按钮 - 固定在右下角 -->
                <div class="position-fixed bottom-0 end-0 m-4">
                    <button class="btn btn-primary btn-lg rounded-circle shadow" data-bs-toggle="modal" data-bs-target="#addPigModal" aria-label="添加母猪">
                        <i class="bi bi-plus fs-4"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加母猪模态框 -->
<div class="modal fade" id="addPigModal" tabindex="-1" aria-labelledby="addPigModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addPigModalLabel">添加母猪</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addPigForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="ear_tag" class="form-label">耳标号*</label>
                            <input type="text" class="form-control" id="ear_tag" name="ear_tag" required>
                        </div>
                        <div class="col-md-6">
                            <label for="birth_date" class="form-label">出生日期*</label>
                            <input type="date" class="form-control" id="birth_date" name="birth_date" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="breed" class="form-label">品种*</label>
                            <select class="form-select" id="breed" name="breed" required>
                                <option value="">请选择品种</option>
                                <option value="大白">大白</option>
                                <option value="长白">长白</option>
                                <option value="杜洛克">杜洛克</option>
                                <option value="皮特兰">皮特兰</option>
                                <option value="巴克夏">巴克夏</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="pen_id" class="form-label">猪圈*</label>
                            <select class="form-select" id="pen_id" name="pen_id" required>
                                <option value="">请选择猪圈</option>
                                {% for pen in pig_pens %}
                                <option value="{{ pen.id }}">{{ pen.pen_number }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="status" class="form-label">状态*</label>
                            <select class="form-select" id="status" name="status" required>
                                <option value="">请选择状态</option>
                                <option value="正常">正常</option>
                                <option value="妊娠">妊娠</option>
                                <option value="哺乳">哺乳</option>
                                <option value="分娩">分娩</option>
                                <option value="休息">休息</option>
                                <option value="治疗">治疗</option>
                                <option value="淘汰">淘汰</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="health_status" class="form-label">健康状况*</label>
                            <select class="form-select" id="health_status" name="health_status" required>
                                <option value="">请选择健康状况</option>
                                <option value="健康">健康</option>
                                <option value="待观察">待观察</option>
                                <option value="治疗中">治疗中</option>
                                <option value="隔离中">隔离中</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="weight" class="form-label">体重(kg)*</label>
                            <input type="number" step="0.1" min="0" class="form-control" id="weight" name="weight" required>
                        </div>
                        <div class="col-md-6">
                            <label for="backfat_thickness" class="form-label">背膘厚度(mm)</label>
                            <input type="number" step="0.1" min="0" class="form-control" id="backfat_thickness" name="backfat_thickness">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="entry_date" class="form-label">入场日期*</label>
                            <input type="date" class="form-control" id="entry_date" name="entry_date" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">备注</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveAddPigBtn">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑母猪模态框 -->
<div class="modal fade" id="editPigModal" tabindex="-1" aria-labelledby="editPigModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPigModalLabel">编辑母猪</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editPigForm">
                    <input type="hidden" id="edit_pig_id" name="pig_id">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit_ear_tag" class="form-label">耳标号*</label>
                            <input type="text" class="form-control" id="edit_ear_tag" name="ear_tag" required>
                        </div>
                        <div class="col-md-6">
                            <label for="edit_birth_date" class="form-label">出生日期*</label>
                            <input type="date" class="form-control" id="edit_birth_date" name="birth_date" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit_breed" class="form-label">品种*</label>
                            <select class="form-select" id="edit_breed" name="breed" required>
                                <option value="">请选择品种</option>
                                <option value="大白">大白</option>
                                <option value="长白">长白</option>
                                <option value="杜洛克">杜洛克</option>
                                <option value="皮特兰">皮特兰</option>
                                <option value="巴克夏">巴克夏</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="edit_pen_id" class="form-label">猪圈*</label>
                            <select class="form-select" id="edit_pen_id" name="pen_id" required>
                                <option value="">请选择猪圈</option>
                                {% for pen in pig_pens %}
                                <option value="{{ pen.id }}">{{ pen.pen_number }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit_status" class="form-label">状态*</label>
                            <select class="form-select" id="edit_status" name="status" required>
                                <option value="">请选择状态</option>
                                <option value="正常">正常</option>
                                <option value="妊娠">妊娠</option>
                                <option value="哺乳">哺乳</option>
                                <option value="分娩">分娩</option>
                                <option value="休息">休息</option>
                                <option value="治疗">治疗</option>
                                <option value="淘汰">淘汰</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="edit_health_status" class="form-label">健康状况*</label>
                            <select class="form-select" id="edit_health_status" name="health_status" required>
                                <option value="">请选择健康状况</option>
                                <option value="健康">健康</option>
                                <option value="待观察">待观察</option>
                                <option value="治疗中">治疗中</option>
                                <option value="隔离中">隔离中</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit_weight" class="form-label">体重(kg)*</label>
                            <input type="number" step="0.1" min="0" class="form-control" id="edit_weight" name="weight" required>
                        </div>
                        <div class="col-md-6">
                            <label for="edit_backfat_thickness" class="form-label">背膘厚度(mm)</label>
                            <input type="number" step="0.1" min="0" class="form-control" id="edit_backfat_thickness" name="backfat_thickness">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit_entry_date" class="form-label">入场日期*</label>
                            <input type="date" class="form-control" id="edit_entry_date" name="entry_date" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_notes" class="form-label">备注</label>
                        <textarea class="form-control" id="edit_notes" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveEditPigBtn">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 查看母猪详情模态框 -->
<div class="modal fade" id="viewPigModal" tabindex="-1" aria-labelledby="viewPigModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewPigModalLabel">母猪详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <h5>基本信息</h5>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <tr>
                                        <th class="bg-light" width="35%">耳标号</th>
                                        <td id="view_ear_tag"></td>
                                    </tr>
                                    <tr>
                                        <th class="bg-light">出生日期</th>
                                        <td id="view_birth_date"></td>
                                    </tr>
                                    <tr>
                                        <th class="bg-light">品种</th>
                                        <td id="view_breed"></td>
                                    </tr>
                                    <tr>
                                        <th class="bg-light">体重(kg)</th>
                                        <td id="view_weight"></td>
                                    </tr>
                                    <tr>
                                        <th class="bg-light">背膘厚度(mm)</th>
                                        <td id="view_backfat_thickness"></td>
                                    </tr>
                                    <tr>
                                        <th class="bg-light">入场日期</th>
                                        <td id="view_entry_date"></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <h5>状态信息</h5>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <tr>
                                        <th class="bg-light" width="35%">当前状态</th>
                                        <td id="view_status"></td>
                                    </tr>
                                    <tr>
                                        <th class="bg-light">健康状况</th>
                                        <td id="view_health_status"></td>
                                    </tr>
                                    <tr>
                                        <th class="bg-light">所在猪圈</th>
                                        <td id="view_pen"></td>
                                    </tr>
                                    <tr>
                                        <th class="bg-light">备注</th>
                                        <td id="view_notes"></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 饲喂记录 -->
                <div class="mt-3">
                    <h5>最近饲喂记录</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead class="bg-light">
                                <tr>
                                    <th>时间</th>
                                    <th>饲料类型</th>
                                    <th>饲料量(kg)</th>
                                    <th>持续(分钟)</th>
                                    <th>状态</th>
                                </tr>
                            </thead>
                            <tbody id="view_feeding_records">
                                <!-- 动态填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 健康记录 -->
                <div class="mt-3">
                    <h5>最近健康记录</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead class="bg-light">
                                <tr>
                                    <th>日期</th>
                                    <th>体温(°C)</th>
                                    <th>诊断</th>
                                    <th>治疗</th>
                                </tr>
                            </thead>
                            <tbody id="view_health_records">
                                <!-- 动态填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 繁育记录 -->
                <div class="mt-3">
                    <h5>繁育记录</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead class="bg-light">
                                <tr>
                                    <th>配种日期</th>
                                    <th>预产日期</th>
                                    <th>实际分娩</th>
                                    <th>总产仔</th>
                                    <th>健康产仔</th>
                                </tr>
                            </thead>
                            <tbody id="view_breeding_records">
                                <!-- 动态填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary edit-from-view">编辑信息</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* 移动设备优化 */
    @media (max-width: 768px) {
        .table td, .table th {
            padding: 0.5rem;
            font-size: 0.9rem;
        }
        .badge {
            font-size: 0.7rem;
        }
        .btn-group-sm .btn {
            padding: 0.2rem 0.4rem;
        }
        .card-body {
            padding: 1rem 0.5rem;
        }
    }
    
    /* 操作按钮样式优化 */
    .btn-group-sm .btn {
        border-radius: 0;
    }
    .btn-group-sm .btn:first-child {
        border-top-left-radius: 0.25rem;
        border-bottom-left-radius: 0.25rem;
    }
    .btn-group-sm .btn:last-child {
        border-top-right-radius: 0.25rem;
        border-bottom-right-radius: 0.25rem;
    }
    
    /* 固定底部按钮样式 */
    .bottom-0 {
        bottom: 0;
    }
    .end-0 {
        right: 0;
    }
    .position-fixed {
        position: fixed;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // 全局变量，用于存储当前正在编辑的猪ID
    let currentPigId = null;
    
    // 添加分页逻辑，处理页面跳转
    document.addEventListener('DOMContentLoaded', function() {
        // 获取所有分页链接
        const pageLinks = document.querySelectorAll('.pagination .page-link:not(.disabled)');
        
        // 为每个分页链接添加点击事件
        pageLinks.forEach(link => {
            if (!link.hasAttribute('aria-disabled')) {
                link.addEventListener('click', function(e) {
                    // 阻止默认点击行为
                    e.preventDefault();
                    
                    // 获取链接的href属性值
                    const href = this.getAttribute('href');
                    if (href) {
                        // 跳转到指定链接
                        window.location.href = href;
                    }
                });
            }
        });
        
        // 提交筛选表单时重置页码为1
        const filterForm = document.getElementById('filterForm');
        if (filterForm) {
            filterForm.addEventListener('submit', function() {
                document.getElementById('page_field').value = 1;
            });
        }
    });
    
    // 分页功能
    function goToPage(page) {
        document.getElementById('page_field').value = page;
        document.getElementById('filterForm').submit();
    }
    
    // 查看母猪详情
    function viewPigDetails(pigId) {
        // 获取和显示母猪信息
        fetch(`/api/pig/${pigId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 基本信息填充
                    const pig = data.data;
                    
                    document.getElementById('view_ear_tag').textContent = pig.ear_tag;
                    document.getElementById('view_birth_date').textContent = pig.birth_date;
                    document.getElementById('view_breed').textContent = pig.breed;
                    document.getElementById('view_weight').textContent = pig.weight;
                    document.getElementById('view_backfat_thickness').textContent = pig.backfat_thickness || '-';
                    document.getElementById('view_entry_date').textContent = pig.entry_date;
                    document.getElementById('view_status').innerHTML = `<span class="badge rounded-pill ${getStatusClass(pig.status)}">${pig.status}</span>`;
                    document.getElementById('view_health_status').innerHTML = `<span class="badge rounded-pill ${getHealthStatusClass(pig.health_status)}">${pig.health_status}</span>`;
                    document.getElementById('view_pen').textContent = pig.pig_pen ? pig.pig_pen.pen_number : '未分配';
                    document.getElementById('view_notes').textContent = pig.notes || '无';
                    
                    // 清空之前的记录
                    document.getElementById('view_feeding_records').innerHTML = '';
                    document.getElementById('view_health_records').innerHTML = '';
                    document.getElementById('view_breeding_records').innerHTML = '';
                    
                    // 填充喂食记录
                    if (pig.feeding_records && pig.feeding_records.length > 0) {
                        document.getElementById('view_feeding_records').innerHTML = pig.feeding_records.map(record => `
                            <tr>
                                <td>${record.date}</td>
                                <td>${record.feed_type}</td>
                                <td>${record.amount}kg</td>
                                <td>${record.notes || '-'}</td>
                            </tr>
                        `).join('');
                    } else {
                        document.getElementById('view_feeding_records').innerHTML = '<tr><td colspan="5" class="text-center">暂无饲喂记录</td></tr>';
                    }
                    
                    // 填充健康记录
                    if (pig.health_records && pig.health_records.length > 0) {
                        document.getElementById('view_health_records').innerHTML = pig.health_records.map(record => `
                            <tr>
                                <td>${record.date}</td>
                                <td>${record.record_type}</td>
                                <td>${record.treatment || '-'}</td>
                                <td>${record.notes || '-'}</td>
                            </tr>
                        `).join('');
                    } else {
                        document.getElementById('view_health_records').innerHTML = '<tr><td colspan="4" class="text-center">暂无健康记录</td></tr>';
                    }
                    
                    // 填充繁殖记录
                    if (pig.breeding_records && pig.breeding_records.length > 0) {
                        document.getElementById('view_breeding_records').innerHTML = pig.breeding_records.map(record => `
                            <tr>
                                <td>${record.date}</td>
                                <td>${record.outcome}</td>
                                <td>${record.litter_size}</td>
                                <td>${record.notes || '-'}</td>
                            </tr>
                        `).join('');
                    } else {
                        document.getElementById('view_breeding_records').innerHTML = '<tr><td colspan="5" class="text-center">暂无繁育记录</td></tr>';
                    }
                    
                    // 存储当前猪ID
                    currentPigId = pigId;
                    
                    // 显示详情模态框
                    const viewModal = new bootstrap.Modal(document.getElementById('viewPigModal'));
                    viewModal.show();
                } else {
                    alert('获取母猪信息失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('获取母猪信息时出错');
            });
    }
    
    // 编辑母猪信息
    function editPig(pigId) {
        // 关闭查看详情的模态框（如果打开的话）
        const viewModal = bootstrap.Modal.getInstance(document.getElementById('viewPigModal'));
        if (viewModal) viewModal.hide();
        
        // 获取和填充表单
        fetch(`/api/pig/${pigId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const pig = data.data;
                    
                    // 填充表单
                    document.getElementById('edit_pig_id').value = pig.id;
                    document.getElementById('edit_ear_tag').value = pig.ear_tag;
                    document.getElementById('edit_birth_date').value = pig.birth_date;
                    document.getElementById('edit_breed').value = pig.breed;
                    document.getElementById('edit_pen_id').value = pig.pig_pen ? pig.pig_pen.id : '';
                    document.getElementById('edit_status').value = pig.status;
                    document.getElementById('edit_health_status').value = pig.health_status;
                    document.getElementById('edit_weight').value = pig.weight;
                    document.getElementById('edit_entry_date').value = pig.entry_date;
                    document.getElementById('edit_notes').value = pig.notes || '';
                    
                    // 显示编辑模态框
                    const editModal = new bootstrap.Modal(document.getElementById('editPigModal'));
                    editModal.show();
                } else {
                    alert('获取母猪信息失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('获取母猪信息时出错');
            });
    }
    
    // 保存编辑的母猪信息
    document.getElementById('saveEditPigBtn').addEventListener('click', function() {
        const form = document.getElementById('editPigForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        const pigId = document.getElementById('edit_pig_id').value;
        const formData = {
            ear_tag: document.getElementById('edit_ear_tag').value,
            birth_date: document.getElementById('edit_birth_date').value,
            breed: document.getElementById('edit_breed').value,
            pen_id: document.getElementById('edit_pen_id').value,
            status: document.getElementById('edit_status').value,
            health_status: document.getElementById('edit_health_status').value,
            weight: document.getElementById('edit_weight').value,
            entry_date: document.getElementById('edit_entry_date').value,
            notes: document.getElementById('edit_notes').value
        };
        
        fetch(`/api/pig/${pigId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('母猪信息更新成功');
                location.reload(); // 刷新页面
            } else {
                alert('更新失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('更新母猪信息时出错');
        });
    });
    
    // 删除母猪
    function deletePig(pigId) {
        if (confirm('确定要删除这头母猪吗？相关的所有记录也将被删除。')) {
            fetch(`/api/pig/${pigId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('母猪删除成功');
                    location.reload(); // 刷新页面
                } else {
                    alert('删除失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('删除母猪时出错');
            });
        }
    }
    
    // 添加母猪模态框显示事件：设置默认日期为今天
    document.getElementById('addPigModal').addEventListener('shown.bs.modal', function () {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('entry_date').value = today;
    });
    
    // 辅助函数：根据状态获取样式类
    function getStatusClass(status) {
        switch(status) {
            case '正常': return 'bg-success';
            case '妊娠': return 'bg-info';
            case '哺乳': return 'bg-primary';
            case '分娩': return 'bg-warning';
            case '休息': return 'bg-secondary';
            case '治疗': return 'bg-danger';
            case '淘汰': return 'bg-dark';
            default: return 'bg-light text-dark';
        }
    }
    
    // 辅助函数：根据健康状态获取样式类
    function getHealthStatusClass(healthStatus) {
        switch(healthStatus) {
            case '健康': return 'bg-success';
            case '待观察': return 'bg-warning';
            case '治疗中': return 'bg-danger';
            case '隔离中': return 'bg-dark';
            default: return 'bg-light text-dark';
        }
    }
</script>
{% endblock %} 