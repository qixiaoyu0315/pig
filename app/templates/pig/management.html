{% extends "admin_layout.html" %}

{% block title %}母猪管理 - 母猪管理系统{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="/home">首页</a></li>
<li class="breadcrumb-item active">母猪管理</li>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between mb-3">
                    <h5 class="card-title">母猪概况</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#addPigModal">
                            <i class="bi bi-plus-circle"></i> 添加母猪
                        </button>
                        <button class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-upload"></i> 导入数据
                        </button>
                    </div>
                </div>
                
                <div class="row g-4">
                    <div class="col-md-3 col-sm-6">
                        <div class="border rounded p-3 text-center">
                            <h1 class="display-4 mb-0">{{ total_count }}</h1>
                            <p class="mb-0 text-muted">总猪只数</p>
                        </div>
                    </div>
                    <div class="col-md-9 col-sm-6">
                        <div class="border rounded p-3">
                            <h5 class="mb-3 text-center">猪群状态分布</h5>
                            <div class="row">
                                {% for status, count in status_counts.items() %}
                                <div class="col-md-2 col-4 text-center mb-2">
                                    <div class="p-2 rounded
                                        {% if status == '妊娠' %}bg-info text-white
                                        {% elif status == '哺乳' %}bg-success text-white
                                        {% elif status == '分娩' %}bg-primary text-white
                                        {% elif status == '休息' %}bg-warning
                                        {% elif status == '治疗' %}bg-danger text-white
                                        {% elif status == '淘汰' %}bg-secondary text-white
                                        {% else %}bg-light
                                        {% endif %}">
                                        <h5 class="mb-0">{{ count }}</h5>
                                        <small>{{ status }}</small>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 猪舍信息 -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">猪舍信息</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for house in pig_houses %}
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>{{ house.name }}</span>
                                <span class="badge bg-primary">{{ house.current_count }}/{{ house.capacity }}</span>
                            </div>
                            <div class="card-body">
                                <p class="mb-1"><strong>位置:</strong> {{ house.location }}</p>
                                <p class="mb-1"><strong>负责人:</strong> {{ house.manager }}</p>
                                <p class="mb-1"><strong>温度:</strong> {{ house.temperature|round(1) }}°C</p>
                                <p class="mb-0"><strong>湿度:</strong> {{ house.humidity|round(1) }}%</p>
                                
                                <!-- 使用率进度条 -->
                                <div class="mt-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>使用率</span>
                                        <span>{{ (house.current_count / house.capacity * 100)|round(1) if house.capacity > 0 else 0 }}%</span>
                                    </div>
                                    <div class="progress" style="height: 10px;">
                                        {% if house.current_count / house.capacity < 0.5 %}
                                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ (house.current_count / house.capacity * 100)|round(1) if house.capacity > 0 else 0 }}%" aria-valuenow="{{ (house.current_count / house.capacity * 100)|round(1) if house.capacity > 0 else 0 }}" aria-valuemin="0" aria-valuemax="100"></div>
                                        {% elif house.current_count / house.capacity < 0.8 %}
                                            <div class="progress-bar bg-info" role="progressbar" style="width: {{ (house.current_count / house.capacity * 100)|round(1) if house.capacity > 0 else 0 }}%" aria-valuenow="{{ (house.current_count / house.capacity * 100)|round(1) if house.capacity > 0 else 0 }}" aria-valuemin="0" aria-valuemax="100"></div>
                                        {% elif house.current_count / house.capacity < 1 %}
                                            <div class="progress-bar bg-warning" role="progressbar" style="width: {{ (house.current_count / house.capacity * 100)|round(1) if house.capacity > 0 else 0 }}%" aria-valuenow="{{ (house.current_count / house.capacity * 100)|round(1) if house.capacity > 0 else 0 }}" aria-valuemin="0" aria-valuemax="100"></div>
                                        {% else %}
                                            <div class="progress-bar bg-danger" role="progressbar" style="width: {{ (house.current_count / house.capacity * 100)|round(1) if house.capacity > 0 else 0 }}%" aria-valuenow="{{ (house.current_count / house.capacity * 100)|round(1) if house.capacity > 0 else 0 }}" aria-valuemin="0" aria-valuemax="100"></div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 筛选表单 -->
<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="GET" action="/pig/management" id="filterForm">
                    <input type="hidden" name="page" value="1" id="page_field">
                    <div class="row g-2">
                        <div class="col-md-3">
                            <label for="keyword" class="form-label">搜索耳标号或母猪号</label>
                            <input type="text" class="form-control" id="keyword" name="keyword" placeholder="输入耳标号或母猪号" value="{{ keyword or '' }}">
                        </div>
                        <div class="col-md-2">
                            <label for="status" class="form-label">状态筛选</label>
                            <select class="form-select" id="status" name="status">
                                <option value="">全部状态</option>
                                <option value="正常" {% if filter_status == '正常' %}selected{% endif %}>正常</option>
                                <option value="妊娠" {% if filter_status == '妊娠' %}selected{% endif %}>妊娠</option>
                                <option value="哺乳" {% if filter_status == '哺乳' %}selected{% endif %}>哺乳</option>
                                <option value="分娩" {% if filter_status == '分娩' %}selected{% endif %}>分娩</option>
                                <option value="休息" {% if filter_status == '休息' %}selected{% endif %}>休息</option>
                                <option value="治疗" {% if filter_status == '治疗' %}selected{% endif %}>治疗</option>
                                <option value="淘汰" {% if filter_status == '淘汰' %}selected{% endif %}>淘汰</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="health_status" class="form-label">健康状态</label>
                            <select class="form-select" id="health_status" name="health_status">
                                <option value="">全部健康状态</option>
                                <option value="健康" {% if filter_health_status == '健康' %}selected{% endif %}>健康</option>
                                <option value="待观察" {% if filter_health_status == '待观察' %}selected{% endif %}>待观察</option>
                                <option value="治疗中" {% if filter_health_status == '治疗中' %}selected{% endif %}>治疗中</option>
                                <option value="隔离中" {% if filter_health_status == '隔离中' %}selected{% endif %}>隔离中</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="pen_id" class="form-label">猪舍筛选</label>
                            <select class="form-select" id="pen_id" name="pen_id">
                                <option value="">全部猪舍</option>
                                {% for pen in pig_pens %}
                                <option value="{{ pen.id }}" {% if filter_pen_id|string == pen.id|string %}selected{% endif %}>{{ pen.pen_number }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label d-block">&nbsp;</label>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary flex-grow-1">
                                    <i class="fas fa-filter"></i> 应用筛选
                                </button>
                                {% if keyword or filter_status or filter_health_status or filter_pen_id %}
                                <a href="/pig/management" class="btn btn-outline-secondary flex-grow-1">
                                    <i class="fas fa-times"></i> 清除筛选
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 母猪列表 -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>母猪列表</h5>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addPigModal">
                    <i class="fas fa-plus"></i> 添加母猪
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 120px;">耳标号</th>
                                <th style="width: 100px;">母猪号</th>
                                <th style="width: 80px;">胎次</th>
                                <th style="width: 80px;">品种</th>
                                <th style="width: 80px;">体重(kg)</th>
                                <th style="width: 80px;">背膘(mm)</th>
                                <th style="width: 90px;">状态</th>
                                <th style="width: 90px;">健康状态</th>
                                <th style="width: 100px;">所在猪舍</th>
                                <th style="width: 120px;">入栏日期</th>
                                <th style="width: 120px;">妊娠天数</th>
                                <th style="width: 160px;" class="text-center">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if pigs %}
                                {% for pig in pigs %}
                                <tr>
                                    <td>{{ pig.ear_tag }}</td>
                                    <td>{{ pig.sow_number if pig.sow_number else '-' }}</td>
                                    <td>{{ pig.parity }}</td>
                                    <td>{{ pig.breed }}</td>
                                    <td>{{ "%.1f"|format(pig.weight) }}</td>
                                    <td>{{ "%.1f"|format(pig.backfat_thickness) if pig.backfat_thickness else '-' }}</td>
                                    <td><span class="badge {{ pig.status|status_class }}">{{ pig.status }}</span></td>
                                    <td><span class="badge {{ pig.health_status|health_status_class }}">{{ pig.health_status }}</span></td>
                                    <td>{{ pig.pen.pen_number if pig.pen else "-" }}</td>
                                    <td>{{ pig.entry_date.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        {% if pig.status == '妊娠' and pig.pregnancy_days is not none %}
                                            <span class="badge bg-info">{{ pig.pregnancy_days }}天</span>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="d-flex justify-content-center">
                                            <button class="btn btn-outline-primary m-1" onclick="viewPigDetails({{ pig.id }})">
                                                <i class="fas fa-eye"></i> 查看
                                            </button>
                                            <button class="btn btn-outline-success m-1" onclick="editPig({{ pig.id }})">
                                                <i class="fas fa-edit"></i> 编辑
                                            </button>
                                            {% if pig.status == '妊娠' %}
                                            <button class="btn btn-outline-info m-1" onclick="editBreedingRecord({{ pig.id }})">
                                                <i class="fas fa-pen"></i> 繁育
                                            </button>
                                            {% else %}
                                            <button class="btn btn-outline-info m-1" onclick="addBreedingRecord({{ pig.id }})">
                                                <i class="fas fa-plus"></i> 繁育
                                            </button>
                                            {% endif %}
                                            <button class="btn btn-outline-danger m-1" onclick="deletePig({{ pig.id }})">
                                                <i class="fas fa-trash"></i> 删除
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="11" class="text-center">暂无数据</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <p class="text-muted mb-0">共 {{ total_count }} 条记录，当前显示第 {{ current_page }}/{{ total_pages }} 页</p>
                    </div>
                    <div class="col-md-6">
                        <nav aria-label="分页">
                            <ul class="pagination justify-content-center">
                                <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                                    <a class="page-link" href="?page=1&keyword={{ keyword or '' }}&status={{ filter_status or '' }}&health_status={{ filter_health_status or '' }}&pen_id={{ filter_pen_id or '' }}" aria-label="首页">
                                        <span aria-hidden="true">&laquo;&laquo;</span>
                                    </a>
                                </li>
                                <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                                    <a class="page-link" href="?page={{ current_page - 1 }}&keyword={{ keyword or '' }}&status={{ filter_status or '' }}&health_status={{ filter_health_status or '' }}&pen_id={{ filter_pen_id or '' }}" aria-label="上一页">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                
                                {% set start_page = [1, current_page - 2]|max %}
                                {% set end_page = [total_pages, current_page + 2]|min %}
                                
                                {% for page_num in range(start_page, end_page + 1) %}
                                <li class="page-item {% if page_num == current_page %}active{% endif %}">
                                    <a class="page-link" href="?page={{ page_num }}&keyword={{ keyword or '' }}&status={{ filter_status or '' }}&health_status={{ filter_health_status or '' }}&pen_id={{ filter_pen_id or '' }}">{{ page_num }}</a>
                                </li>
                                {% endfor %}
                                
                                <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                                    <a class="page-link" href="?page={{ current_page + 1 }}&keyword={{ keyword or '' }}&status={{ filter_status or '' }}&health_status={{ filter_health_status or '' }}&pen_id={{ filter_pen_id or '' }}" aria-label="下一页">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                                <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                                    <a class="page-link" href="?page={{ total_pages }}&keyword={{ keyword or '' }}&status={{ filter_status or '' }}&health_status={{ filter_health_status or '' }}&pen_id={{ filter_pen_id or '' }}" aria-label="尾页">
                                        <span aria-hidden="true">&raquo;&raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加母猪模态框 -->
<div class="modal fade" id="addPigModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加母猪</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addPigForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="addEarTag" class="form-label">耳标号 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="addEarTag" name="ear_tag" required placeholder="15616800XXXX">
                            <small class="form-text text-muted">将自动格式化为 15616800 开头</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="addSowNumber" class="form-label">母猪号</label>
                            <input type="text" class="form-control" id="addSowNumber" name="sow_number" placeholder="NXXXXX">
                            <small class="form-text text-muted">不填将自动生成 N 开头的编号</small>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="addBirthDate" class="form-label">出生日期 <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="addBirthDate" name="birth_date" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="addBreed" class="form-label">品种 <span class="text-danger">*</span></label>
                            <select class="form-select" id="addBreed" name="breed" required>
                                <option value="">请选择</option>
                                <option value="大白">大白</option>
                                <option value="长白">长白</option>
                                <option value="杜洛克">杜洛克</option>
                                <option value="皮特兰">皮特兰</option>
                                <option value="巴克夏">巴克夏</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="addParity" class="form-label">胎次</label>
                            <input type="number" class="form-control" id="addParity" name="parity" min="0" value="0">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="addWeight" class="form-label">体重(kg) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="addWeight" name="weight" step="0.1" min="0" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="addBackfatThickness" class="form-label">背膘厚度(mm)</label>
                            <input type="number" class="form-control" id="addBackfatThickness" name="backfat_thickness" step="0.1" min="0">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="addPenId" class="form-label">所在猪舍 <span class="text-danger">*</span></label>
                            <select class="form-select" id="addPenId" name="pen_id" required>
                                <option value="">请选择</option>
                                {% for pen in pig_pens %}
                                <option value="{{ pen.id }}">{{ pen.pen_number }} ({{ pen.type }})</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="addStatus" class="form-label">状态 <span class="text-danger">*</span></label>
                            <select class="form-select" id="addStatus" name="status" required>
                                <option value="正常">正常</option>
                                <option value="妊娠">妊娠</option>
                                <option value="哺乳">哺乳</option>
                                <option value="分娩">分娩</option>
                                <option value="休息">休息</option>
                                <option value="治疗">治疗</option>
                                <option value="淘汰">淘汰</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="addHealthStatus" class="form-label">健康状态 <span class="text-danger">*</span></label>
                            <select class="form-select" id="addHealthStatus" name="health_status" required>
                                <option value="健康">健康</option>
                                <option value="待观察">待观察</option>
                                <option value="治疗中">治疗中</option>
                                <option value="隔离中">隔离中</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="addEntryDate" class="form-label">入栏日期 <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="addEntryDate" name="entry_date" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="addNotes" class="form-label">备注</label>
                        <textarea class="form-control" id="addNotes" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="savePigBtn">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑母猪模态框 -->
<div class="modal fade" id="editPigModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑母猪</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editPigForm">
                    <input type="hidden" id="editPigId" name="pig_id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editEarTag" class="form-label">耳标号 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editEarTag" name="ear_tag" required placeholder="15616800XXXX">
                            <small class="form-text text-muted">将自动格式化为 15616800 开头</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editSowNumber" class="form-label">母猪号</label>
                            <input type="text" class="form-control" id="editSowNumber" name="sow_number" placeholder="NXXXXX">
                            <small class="form-text text-muted">N 开头的编号</small>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="editBirthDate" class="form-label">出生日期 <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="editBirthDate" name="birth_date" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="editBreed" class="form-label">品种 <span class="text-danger">*</span></label>
                            <select class="form-select" id="editBreed" name="breed" required>
                                <option value="">请选择</option>
                                <option value="大白">大白</option>
                                <option value="长白">长白</option>
                                <option value="杜洛克">杜洛克</option>
                                <option value="皮特兰">皮特兰</option>
                                <option value="巴克夏">巴克夏</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="editParity" class="form-label">胎次</label>
                            <input type="number" class="form-control" id="editParity" name="parity" min="0" value="0">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="editWeight" class="form-label">体重(kg) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="editWeight" name="weight" step="0.1" min="0" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="editBackfatThickness" class="form-label">背膘厚度(mm)</label>
                            <input type="number" class="form-control" id="editBackfatThickness" name="backfat_thickness" step="0.1" min="0">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="editPenId" class="form-label">所在猪舍 <span class="text-danger">*</span></label>
                            <select class="form-select" id="editPenId" name="pen_id" required>
                                <option value="">请选择</option>
                                {% for pen in pig_pens %}
                                <option value="{{ pen.id }}">{{ pen.pen_number }} ({{ pen.type }})</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="editStatus" class="form-label">状态 <span class="text-danger">*</span></label>
                            <select class="form-select" id="editStatus" name="status" required>
                                <option value="正常">正常</option>
                                <option value="妊娠">妊娠</option>
                                <option value="哺乳">哺乳</option>
                                <option value="分娩">分娩</option>
                                <option value="休息">休息</option>
                                <option value="治疗">治疗</option>
                                <option value="淘汰">淘汰</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="editHealthStatus" class="form-label">健康状态 <span class="text-danger">*</span></label>
                            <select class="form-select" id="editHealthStatus" name="health_status" required>
                                <option value="健康">健康</option>
                                <option value="待观察">待观察</option>
                                <option value="治疗中">治疗中</option>
                                <option value="隔离中">隔离中</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="editEntryDate" class="form-label">入栏日期 <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="editEntryDate" name="entry_date" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editNotes" class="form-label">备注</label>
                        <textarea class="form-control" id="editNotes" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="updatePigBtn">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 查看母猪详情模态框 -->
<div class="modal fade" id="viewPigModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">母猪详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="border-bottom pb-2 mb-3">基本信息</h6>
                        <div class="row mb-2">
                            <div class="col-md-4 fw-bold">耳标号:</div>
                            <div class="col-md-8" id="viewEarTag"></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-4 fw-bold">母猪号:</div>
                            <div class="col-md-8" id="viewSowNumber"></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-4 fw-bold">胎次:</div>
                            <div class="col-md-8" id="viewParity"></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-4 fw-bold">出生日期:</div>
                            <div class="col-md-8" id="viewBirthDate"></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-4 fw-bold">品种:</div>
                            <div class="col-md-8" id="viewBreed"></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-4 fw-bold">体重:</div>
                            <div class="col-md-8" id="viewWeight"></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-4 fw-bold">背膘厚度:</div>
                            <div class="col-md-8" id="viewBackfatThickness"></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-4 fw-bold">备注:</div>
                            <div class="col-md-8" id="viewNotes"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="border-bottom pb-2 mb-3">状态信息</h6>
                        <div class="row mb-2">
                            <div class="col-md-4 fw-bold">状态:</div>
                            <div class="col-md-8" id="viewStatus"></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-4 fw-bold">健康状态:</div>
                            <div class="col-md-8" id="viewHealthStatus"></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-4 fw-bold">所在猪舍:</div>
                            <div class="col-md-8" id="viewPen"></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-4 fw-bold">入栏日期:</div>
                            <div class="col-md-8" id="viewEntryDate"></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-4 fw-bold">最后配种日期:</div>
                            <div class="col-md-8" id="viewLastBreedingDate"></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-4 fw-bold">妊娠天数:</div>
                            <div class="col-md-8" id="viewPregnancyDays"></div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <ul class="nav nav-tabs" id="viewPigTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="feeding-tab" data-bs-toggle="tab" data-bs-target="#feeding" type="button" role="tab" aria-controls="feeding" aria-selected="true">最近采食记录</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="health-tab" data-bs-toggle="tab" data-bs-target="#health" type="button" role="tab" aria-controls="health" aria-selected="false">健康记录</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="breeding-tab" data-bs-toggle="tab" data-bs-target="#breeding" type="button" role="tab" aria-controls="breeding" aria-selected="false">繁育记录</button>
                        </li>
                    </ul>
                    <div class="tab-content p-3 border border-top-0 rounded-bottom" id="viewPigTabContent">
                        <div class="tab-pane fade show active" id="feeding" role="tabpanel" aria-labelledby="feeding-tab">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>喂食时间</th>
                                            <th>喂食量(kg)</th>
                                            <th>饲料类型</th>
                                            <th>状态</th>
                                        </tr>
                                    </thead>
                                    <tbody id="feedingRecordsBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="health" role="tabpanel" aria-labelledby="health-tab">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>记录日期</th>
                                            <th>体温(°C)</th>
                                            <th>诊断</th>
                                            <th>治疗方案</th>
                                        </tr>
                                    </thead>
                                    <tbody id="healthRecordsBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="breeding" role="tabpanel" aria-labelledby="breeding-tab">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>配种日期</th>
                                            <th>状态</th>
                                            <th>预产期</th>
                                            <th>实际分娩日期</th>
                                            <th>总产仔数</th>
                                            <th>活仔数</th>
                                        </tr>
                                    </thead>
                                    <tbody id="breedingRecordsBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="editFromViewBtn">编辑</button>
            </div>
        </div>
    </div>
</div>

<!-- 添加繁育记录模态框 -->
<div class="modal fade" id="addBreedingModal" tabindex="-1" aria-labelledby="addBreedingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addBreedingModalLabel">添加繁育记录</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addBreedingForm">
                    <input type="hidden" id="add_breeding_pig_id" name="pig_id">
                    <div class="mb-3">
                        <label for="add_breeding_pig_info" class="form-label">母猪信息</label>
                        <p id="add_breeding_pig_info" class="form-control-plaintext"></p>
                    </div>
                    <div class="mb-3">
                        <label for="breeding_date" class="form-label">配种日期*</label>
                        <input type="date" class="form-control" id="breeding_date" name="breeding_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="expected_farrowing_date" class="form-label">预产期</label>
                        <input type="date" class="form-control" id="expected_farrowing_date" name="expected_farrowing_date">
                        <div class="form-text">默认为配种日期后114天</div>
                    </div>
                    <div class="mb-3">
                        <label for="breeding_notes" class="form-label">备注</label>
                        <textarea class="form-control" id="breeding_notes" name="notes" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveBreedingBtn">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 更新繁育记录模态框 -->
<div class="modal fade" id="updateBreedingModal" tabindex="-1" aria-labelledby="updateBreedingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateBreedingModalLabel">更新繁育记录</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="updateBreedingForm">
                    <input type="hidden" id="update_breeding_record_id" name="record_id">
                    <div class="mb-3">
                        <label for="update_breeding_pig_info" class="form-label">母猪信息</label>
                        <p id="update_breeding_pig_info" class="form-control-plaintext"></p>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="update_breeding_date" class="form-label">配种日期*</label>
                            <input type="date" class="form-control" id="update_breeding_date" name="breeding_date" readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="update_expected_farrowing_date" class="form-label">预产期*</label>
                            <input type="date" class="form-control" id="update_expected_farrowing_date" name="expected_farrowing_date" readonly>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="update_pregnancy_days" class="form-label">已孕天数</label>
                            <input type="text" class="form-control" id="update_pregnancy_days" readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="breeding_status" class="form-label">记录状态*</label>
                            <select class="form-select" id="breeding_status" name="status" required>
                                <option value="进行中">进行中</option>
                                <option value="已分娩">已分娩</option>
                                <option value="已流产">已流产</option>
                                <option value="已取消">已取消</option>
                            </select>
                        </div>
                    </div>
                    <div id="farrowing_details" style="display: none;">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="actual_farrowing_date" class="form-label">实际分娩日期*</label>
                                <input type="date" class="form-control" id="actual_farrowing_date" name="actual_farrowing_date">
                            </div>
                            <div class="col-md-6">
                                <label for="total_born" class="form-label">总产仔数*</label>
                                <input type="number" class="form-control" id="total_born" name="total_born" min="0">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="born_alive" class="form-label">活产数*</label>
                                <input type="number" class="form-control" id="born_alive" name="born_alive" min="0">
                            </div>
                            <div class="col-md-6">
                                <label for="stillborn" class="form-label">死胎数</label>
                                <input type="number" class="form-control" id="stillborn" name="stillborn" min="0">
                                <div class="form-text">默认为总产仔数减去活产数</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="update_breeding_notes" class="form-label">备注</label>
                        <textarea class="form-control" id="update_breeding_notes" name="notes" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="updateBreedingBtn">保存</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', function() {
        // 为添加母猪模态框设置当天日期
        document.querySelector('#addPigModal').addEventListener('show.bs.modal', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('addEntryDate').value = today;
        });

        // 分页功能
        window.goToPage = function(page) {
            document.getElementById('page_field').value = page;
            document.getElementById('filterForm').submit();
        };

        // 保存新母猪
        document.getElementById('savePigBtn').addEventListener('click', function() {
            const form = document.getElementById('addPigForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const formData = new FormData(form);
            
            fetch('/pig/add', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('添加成功');
                    bootstrap.Modal.getInstance(document.getElementById('addPigModal')).hide();
                    window.location.reload();
                } else {
                    alert('添加失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('系统错误，请重试');
            });
        });
        
        // 更新母猪信息
        document.getElementById('updatePigBtn').addEventListener('click', function() {
            const form = document.getElementById('editPigForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const formData = new FormData(form);
            const pigId = document.getElementById('editPigId').value;
            
            fetch(`/pig/update/${pigId}`, {
                method: 'PUT',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('更新成功');
                    bootstrap.Modal.getInstance(document.getElementById('editPigModal')).hide();
                    window.location.reload();
                } else {
                    alert('更新失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('系统错误，请重试');
            });
        });
        
        // 从详情页编辑按钮
        document.getElementById('editFromViewBtn').addEventListener('click', function() {
            const pigId = this.getAttribute('data-pig-id');
            bootstrap.Modal.getInstance(document.getElementById('viewPigModal')).hide();
            editPig(pigId);
        });
    });

    // 查看母猪详情
    function viewPigDetails(pigId) {
        fetch(`/pig/detail/${pigId}`)
            .then(response => response.json())
            .then(data => {
                // 填充详情模态框
                document.getElementById('viewEarTag').textContent = data.ear_tag || '-';
                document.getElementById('viewSowNumber').textContent = data.sow_number || '-';
                document.getElementById('viewParity').textContent = data.parity || '0';
                document.getElementById('viewBirthDate').textContent = data.birth_date || '-';
                document.getElementById('viewBreed').textContent = data.breed || '-';
                document.getElementById('viewWeight').textContent = data.weight ? `${parseFloat(data.weight).toFixed(1)} kg` : '-';
                document.getElementById('viewBackfatThickness').textContent = data.backfat_thickness ? `${parseFloat(data.backfat_thickness).toFixed(1)} mm` : '-';
                document.getElementById('viewNotes').textContent = data.notes || '-';
                
                document.getElementById('viewStatus').textContent = data.status || '-';
                document.getElementById('viewHealthStatus').textContent = data.health_status || '-';
                document.getElementById('viewPen').textContent = data.pen || '-';
                document.getElementById('viewEntryDate').textContent = data.entry_date || '-';
                document.getElementById('viewLastBreedingDate').textContent = data.last_breeding_date || '-';
                document.getElementById('viewPregnancyDays').textContent = data.pregnancy_days ? `${data.pregnancy_days} 天` : '-';
                
                // 为编辑按钮设置ID
                document.getElementById('editFromViewBtn').setAttribute('data-pig-id', data.id);

                // 填充采食记录
                const feedingRecordsBody = document.getElementById('feedingRecordsBody');
                feedingRecordsBody.innerHTML = '';
                
                if (data.feeding_records && data.feeding_records.length > 0) {
                    data.feeding_records.forEach(record => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${record.feed_time}</td>
                            <td>${record.feed_amount} kg</td>
                            <td>${record.feed_type || '-'}</td>
                            <td>${record.feed_status}</td>
                        `;
                        feedingRecordsBody.appendChild(tr);
                    });
                } else {
                    feedingRecordsBody.innerHTML = '<tr><td colspan="4" class="text-center">暂无采食记录</td></tr>';
                }
                
                // 填充健康记录
                const healthRecordsBody = document.getElementById('healthRecordsBody');
                healthRecordsBody.innerHTML = '';
                
                if (data.health_records && data.health_records.length > 0) {
                    data.health_records.forEach(record => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${record.record_date}</td>
                            <td>${record.temperature || '-'}</td>
                            <td>${record.diagnosis || '-'}</td>
                            <td>${record.treatment || '-'}</td>
                        `;
                        healthRecordsBody.appendChild(tr);
                    });
                } else {
                    healthRecordsBody.innerHTML = '<tr><td colspan="4" class="text-center">暂无健康记录</td></tr>';
                }
                
                // 填充繁育记录
                const breedingRecordsBody = document.getElementById('breedingRecordsBody');
                breedingRecordsBody.innerHTML = '';
                
                if (data.breeding_records && data.breeding_records.length > 0) {
                    data.breeding_records.forEach(record => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${record.breeding_date || '-'}</td>
                            <td>${record.status || '进行中'}</td>
                            <td>${record.expected_farrowing_date || '-'}</td>
                            <td>${record.actual_farrowing_date || '-'}</td>
                            <td>${record.total_born || '-'}</td>
                            <td>${record.born_alive || '-'}</td>
                        `;
                        breedingRecordsBody.appendChild(tr);
                    });
                } else {
                    breedingRecordsBody.innerHTML = '<tr><td colspan="6" class="text-center">暂无繁育记录</td></tr>';
                }
                
                // 显示模态框
                const modal = new bootstrap.Modal(document.getElementById('viewPigModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('获取数据失败，请重试');
            });
    }
    
    // 编辑母猪信息
    function editPig(pigId) {
        fetch(`/pig/detail/${pigId}`)
            .then(response => response.json())
            .then(data => {
                // 填充编辑表单
                document.getElementById('editPigId').value = pigId;
                document.getElementById('editEarTag').value = data.ear_tag;
                document.getElementById('editSowNumber').value = data.sow_number || '';
                document.getElementById('editParity').value = data.parity || '0';
                document.getElementById('editBirthDate').value = data.birth_date;
                document.getElementById('editBreed').value = data.breed;
                document.getElementById('editWeight').value = parseFloat(data.weight).toFixed(1);
                document.getElementById('editBackfatThickness').value = data.backfat_thickness || '';
                document.getElementById('editStatus').value = data.status;
                document.getElementById('editHealthStatus').value = data.health_status;
                document.getElementById('editPenId').value = data.pen_id;
                document.getElementById('editEntryDate').value = data.entry_date;
                document.getElementById('editNotes').value = data.notes || '';
                
                // 显示模态框
                const modal = new bootstrap.Modal(document.getElementById('editPigModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('获取数据失败，请重试');
            });
    }
    
    // 删除母猪
    function deletePig(pigId) {
        if (!confirm('确定要删除这头母猪吗？此操作不可恢复，相关的喂食记录、健康记录和繁育记录也将被删除。')) {
            return;
        }
        
        fetch(`/pig/delete/${pigId}`, {
            method: 'DELETE',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('删除成功');
                window.location.reload();
            } else {
                alert('删除失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('系统错误，请重试');
        });
    }
    
    // 添加繁育记录
    function addBreedingRecord(pigId) {
        // 这里可以实现添加繁育记录逻辑
        alert('该功能将使用现有的繁育记录添加功能，已记录猪只ID: ' + pigId);
    }
    
    // 编辑繁育记录
    function editBreedingRecord(pigId) {
        // 这里可以实现编辑繁育记录逻辑
        alert('该功能将使用现有的繁育记录编辑功能，已记录猪只ID: ' + pigId);
    }

    // 在JavaScript中添加体重格式化函数
</script>
{% endblock %} 